<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì ì§€íœ˜ë³¸ë¶€</title>
  <style>
    body { text-align: center; background-color: #fff3e0; font-family: sans-serif; padding: 20px; }
    .box { background-color: white; padding: 25px; border-radius: 15px; display: inline-block; border: 2px solid #ff9800; max-width: 800px; width: 95%; text-align: left; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 20px; }
    h2 { text-align: center; color: #e65100; font-size: 34px; }
    input, button, select { padding: 15px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; font-size: 20px; width: 100%; box-sizing: border-box; }
    button { background-color: #ff9800; color: white; border: none; cursor: pointer; font-weight: bold; margin-bottom: 15px; }
    button:hover { background-color: #f57c00; }
    h3 { color: #d84315; border-bottom: 2px solid #ffe0b2; padding-bottom: 5px; margin-top: 40px; font-size: 26px; }
    
    .history-item, .user-list-item { font-size: 18px; padding: 15px; background-color: #fafafa; border-left: 5px solid #ff9800; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-radius: 0 5px 5px 0; }
    .btn-delete { background-color: #e53935; padding: 10px 15px; font-size: 16px; width: auto; margin: 0; }
    
    /* ì±„íŒ… ê´€ë ¨ */
    #adminChatArea { height: 300px; overflow-y: auto; border: 1px solid #ccc; background-color: #f5f5f5; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
    .msg-worker { text-align: left; margin: 10px 0; }
    .msg-admin { text-align: right; margin: 10px 0; }
    .bubble { display: inline-block; padding: 10px; border-radius: 10px; max-width: 80%; font-size: 18px; word-break: break-all; }
    .bubble-worker { background-color: #fff; border: 1px solid #ccc; }
    .bubble-admin { background-color: #ffcc80; color: #000; }
    .time-text { font-size: 12px; color: gray; }
  </style>
</head>
<body>
  <div class="box">
    <h2>ğŸ‘¨â€ğŸ’¼ ì§€íœ˜ë³¸ë¶€ (ì™„ì „íŒ)</h2>

    <h3>ğŸ“¢ ì „ì²´ ê³µì§€ (í˜„ìˆ˜ë§‰ ë‹¬ê¸°)</h3>
    <input type="text" id="bannerText" placeholder="ì˜ˆ: ì˜¤ëŠ˜ 15ì‹œë¶€í„° ì •ì „ì…ë‹ˆë‹¤. ì•ˆì „ ì£¼ì˜!">
    <div style="display:flex; gap:10px;">
      <button id="bannerBtn" style="background-color:#d32f2f;">í˜„ìˆ˜ë§‰ ê±¸ê¸°</button>
      <button id="bannerClearBtn" style="background-color:#757575;">í˜„ìˆ˜ë§‰ ë‚´ë¦¬ê¸°</button>
    </div>

    <h3>âœ‰ï¸ 1:1 ê±´ì˜í•¨ (ìª½ì§€ ë³´ë‚´ê¸°/ì½ê¸°)</h3>
    <select id="msgUserSelect"><option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš” (ë¡œë”©ì¤‘...)</option></select>
    <div id="adminChatArea">ì§ì›ì„ ì„ íƒí•˜ë©´ ëŒ€í™”ê°€ ë³´ì…ë‹ˆë‹¤.</div>
    <div style="display:flex; gap:10px;">
      <input type="text" id="adminMsgInput" placeholder="ë‹µê¸€ ë˜ëŠ” ìª½ì§€ ë‚´ìš© ì…ë ¥">
      <button id="adminMsgBtn" style="width: 100px; margin: 5px 0;">ì „ì†¡</button>
    </div>

    <h3>ğŸ“ ì§ì› ê´€ë¦¬ (ì´ <span id="userCount">0</span>ëª…)</h3>
    <input type="text" id="newName" placeholder="ìƒˆ ì§ì› ì´ë¦„">
    <button id="regBtn">ì§ì› ë“±ë¡</button>
    <div id="userListArea" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px;"></div>

    <h3>ğŸ“… ìƒì„¸ ê¸°ë¡ (ë‚ ì§œë³„)</h3>
    <input type="date" id="searchDate">
    <div style="display:flex; gap:10px;">
      <button id="dateSearchBtn">ë‚ ì§œë³„ ì¡°íšŒ</button>
      <button id="allSearchBtn" style="background-color: #757575;">ì „ì²´ë³´ê¸°</button>
    </div>
    <div id="historyArea" style="min-height: 200px; max-height:400px; overflow-y:auto;"></div>

    <div style="text-align: center; margin-top: 30px;">
      <button onclick="location.href='index.html'" style="background-color: #555; padding: 20px;">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </div>

  <script type="module">
    import { db, ref, set, get, push, onValue } from "./firebase-setup.js";

    // --- 1. í˜„ìˆ˜ë§‰ ë§ˆë²• ---
    document.getElementById('bannerBtn').onclick = async () => {
      const text = document.getElementById('bannerText').value.trim();
      if(!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!");
      await set(ref(db, 'settings/banner'), text);
      alert("ëª¨ë“  ì§ì›ì˜ í™”ë©´ì— í˜„ìˆ˜ë§‰ì´ ê±¸ë ¸ìŠµë‹ˆë‹¤!");
      document.getElementById('bannerText').value = "";
    };
    document.getElementById('bannerClearBtn').onclick = async () => {
      await set(ref(db, 'settings/banner'), null);
      alert("í˜„ìˆ˜ë§‰ì„ ë‚´ë ¸ìŠµë‹ˆë‹¤.");
    };

    // --- 2. ê±´ì˜í•¨(ìª½ì§€) ë§ˆë²• ---
    let currentChatUser = "";
    onValue(ref(db, 'scores'), (snap) => {
      const select = document.getElementById('msgUserSelect');
      select.innerHTML = '<option value="">ëŒ€í™”í•  ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
      if(snap.exists()) {
        for(let name in snap.val()) select.innerHTML += `<option value="${name}">${name} ë‹˜</option>`;
      }
    });

    document.getElementById('msgUserSelect').onchange = (e) => {
      currentChatUser = e.target.value;
      const area = document.getElementById('adminChatArea');
      if(!currentChatUser) { area.innerHTML = "ì§ì›ì„ ì„ íƒí•˜ë©´ ëŒ€í™”ê°€ ë³´ì…ë‹ˆë‹¤."; return; }
      
      onValue(ref(db, `messages/${currentChatUser}`), (snap) => {
        area.innerHTML = "";
        const data = snap.val();
        if(!data) { area.innerHTML = `<p style="text-align:center; color:gray;">ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìª½ì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!</p>`; return; }
        
        for(let key in data) {
          const msg = data[key];
          const isMe = msg.sender === 'admin';
          area.innerHTML += `
            <div class="${isMe ? 'msg-admin' : 'msg-worker'}">
              <span class="time-text">${isMe ? '' : currentChatUser}</span>
              <div class="bubble ${isMe ? 'bubble-admin' : 'bubble-worker'}">${msg.text}</div>
              <span class="time-text">${msg.time}</span>
            </div>
          `;
        }
        area.scrollTop = area.scrollHeight;
      });
    };

    document.getElementById('adminMsgBtn').onclick = async () => {
      if(!currentChatUser) return alert("ì§ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");
      const text = document.getElementById('adminMsgInput').value.trim();
      if(!text) return;
      const time = new Date().toLocaleString('ko-KR', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
      await set(push(ref(db, `messages/${currentChatUser}`)), { sender: 'admin', text: text, time: time });
      document.getElementById('adminMsgInput').value = "";
    };

    // --- ê¸°ì¡´ ì§ì›/ê¸°ë¡ ê´€ë¦¬ ë¡œì§ (í¬ê¸°ë§Œ ë§ì¶¤) ---
    document.getElementById('regBtn').onclick = async () => {
      const name = document.getElementById('newName').value.trim();
      if(!name) return;
      await set(ref(db, `scores/${name}`), 0);
      document.getElementById('newName').value = ""; alert(name + "ë‹˜ ë“±ë¡!");
    };
    window.deleteUser = async (name) => {
      if(!confirm(`âš ï¸ '${name}'ë‹˜ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
      await set(ref(db, `scores/${name}`), null);
    };
    onValue(ref(db, 'scores'), (snap) => {
      const data = snap.val();
      const area = document.getElementById('userListArea');
      document.getElementById('userCount').innerText = data ? Object.keys(data).length : 0;
      area.innerHTML = "";
      for(let name in data) area.innerHTML += `<div class='user-list-item'><span>${name} (${data[name]}ì )</span> <button class="btn-delete" onclick="deleteUser('${name}')">ì‚­ì œ</button></div>`;
    });
    let allHistory = [];
    onValue(ref(db, 'history'), (snap) => {
      const data = snap.val(); allHistory = [];
      for(let key in data) allHistory.push({ key, ...data[key] });
      allHistory.reverse(); renderHistory(allHistory);
    });
    document.getElementById('dateSearchBtn').onclick = () => {
      const date = document.getElementById('searchDate').value;
      if(!date) return alert("ë‚ ì§œ ì„ íƒ!");
      const fd = new Date(date).toLocaleDateString('ko-KR');
      renderHistory(allHistory.filter(h => h.date === fd));
    };
    document.getElementById('allSearchBtn').onclick = () => renderHistory(allHistory);
    function renderHistory(list) {
      const area = document.getElementById('historyArea'); area.innerHTML = "";
      list.forEach(h => {
        area.innerHTML += `<div class='history-item'><div><b>${h.name}</b> <small>${h.date}</small><br>${h.mission}</div><div><b style="color:blue">${h.point}</b> <button class="btn-delete" onclick="cancelHistory('${h.key}')">ì·¨ì†Œ</button></div></div>`;
      });
    }
    window.cancelHistory = async (key) => {
      if(!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ê³  ì ìˆ˜ë¥¼ íšŒìˆ˜í• ê¹Œìš”?")) return;
      const snap = await get(ref(db, `history/${key}`));
      if(!snap.exists()) return;
      const h = snap.val();
      const scoreSnap = await get(ref(db, `scores/${h.name}`));
      if(scoreSnap.exists()) await set(ref(db, `scores/${h.name}`), scoreSnap.val() - h.point);
      await set(ref(db, `history/${key}`), null);
    };
  </script>
</body>
</html>
