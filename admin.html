<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì<br>ì§€íœ˜ë³¸ë¶€</title>
  <style>
    body { text-align: center; background-color: #fff3e0; font-family: sans-serif; padding: 20px; }
    .box { background-color: white; padding: 25px; border-radius: 15px; display: inline-block; border: 2px solid #ff9800; max-width: 600px; width: 95%; text-align: left; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #e65100; }
    input, button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { background-color: #ff9800; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background-color: #f57c00; }
    h3 { color: #d84315; border-bottom: 2px solid #ffe0b2; padding-bottom: 5px; margin-top: 30px; }
    
    /* ê¸°ë¡ ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .history-container { min-height: 400px; }
    .history-item { background-color: #fafafa; border-left: 5px solid #ff9800; padding: 10px; margin-bottom: 8px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; border-radius: 0 5px 5px 0; }
    .btn-delete { background-color: #e53935; padding: 5px 10px; font-size: 12px; }

    /* í˜ì´ì§€ë„¤ì´ì…˜ (ë²ˆí˜¸ ëˆ„ë¥´ê¸°) */
    .pagination { text-align: center; margin-top: 20px; }
    .page-btn { display: inline-block; padding: 8px 12px; margin: 2px; border: 1px solid #ddd; background: white; cursor: pointer; color: #333; border-radius: 4px; }
    .page-btn.active { background-color: #ff9800; color: white; border-color: #ff9800; }

    /* ì§ì› ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .user-list-item { background-color: #f5f5f5; padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>
  <div class="box">
    <h2>ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì ì§€íœ˜ë³¸ë¶€</h2>
    
    <h3>ğŸ“ ì‹ ê·œ ì§ì› ë“±ë¡</h3>
    <input type="text" id="newName" placeholder="ì´ë¦„ ì…ë ¥">
    <button id="regBtn">ë“±ë¡í•˜ê¸°</button>

    <h3>ğŸ“‹ ì „ì²´ ì§ì› í˜„í™© (ì´ <span id="userCount">0</span>ëª…)</h3>
    <div id="userListArea" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px;"></div>

    <h3>âš–ï¸ ì ìˆ˜ ìˆ˜ë™ ì¡°ì ˆ</h3>
    <input type="text" id="adjName" placeholder="ì´ë¦„">
    <input type="number" id="adjPoint" placeholder="ì ìˆ˜(ì˜ˆ: 10 ë˜ëŠ” -10)">
    <button id="adjBtn">ì ìš©</button>

    <h3>ğŸ“… ìƒì„¸ ê¸°ë¡ ì¡°íšŒ (ë‚ ì§œë³„)</h3>
    <div style="margin-bottom: 15px;">
      <input type="date" id="searchDate">
      <button id="dateSearchBtn">ë‚ ì§œë³„ ì¡°íšŒ</button>
      <button id="allSearchBtn" style="background-color: #757575;">ì „ì²´ë³´ê¸°</button>
    </div>
    
    <div id="historyArea" class="history-container">
      </div>
    
    <div id="paginationArea" class="pagination"></div>

    <div style="text-align: center; margin-top: 30px;">
 <button onclick="location.href='index.html'" style="background-color: #555; padding: 15px; font-size: 20px; border-radius: 10px; color: white; border: none; cursor: pointer;">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </div>

  <script type="module">
    import { db, ref, set, get, push, onValue } from "./firebase-setup.js";

    // --- ë³€ìˆ˜ ì„¤ì • ---
    let allHistory = []; // ì „ì²´ ê¸°ë¡ ì €ì¥ìš©
    let filteredHistory = []; // ë‚ ì§œ í•„í„°ë§ëœ ê¸°ë¡ ì €ì¥ìš©
    let currentPage = 1;
    const itemsPerPage = 10;

    // --- 1. ì§ì› ê´€ë¦¬ (ë“±ë¡/ì‚­ì œ/ëª©ë¡) ---
    document.getElementById('regBtn').onclick = async () => {
      const name = document.getElementById('newName').value.trim();
      if(!name) return;
      await set(ref(db, `scores/${name}`), 0);
      document.getElementById('newName').value = "";
      alert(name + "ë‹˜ ë“±ë¡ ì™„ë£Œ!");
    };

    window.deleteUser = async (name) => {
      if(!confirm(`âš ï¸ '${name}'ë‹˜ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
      await set(ref(db, `scores/${name}`), null);
      await set(ref(db, `stamps/${name}`), null);
    };

    onValue(ref(db, 'scores'), (snap) => {
      const data = snap.val();
      const area = document.getElementById('userListArea');
      const countArea = document.getElementById('userCount');
      area.innerHTML = "";
      if(!data) { countArea.innerText = "0"; return; }
      let count = 0;
      for(let name in data) {
        count++;
        area.innerHTML += `<div class='user-list-item'><span>${name} (${data[name]}ì )</span>
          <button class="btn-delete" onclick="deleteUser('${name}')">ì‚­ì œ</button></div>`;
      }
      countArea.innerText = count;
    });

    // --- 2. ì ìˆ˜ ì¡°ì ˆ ---
    document.getElementById('adjBtn').onclick = async () => {
      const name = document.getElementById('adjName').value.trim();
      const point = parseInt(document.getElementById('adjPoint').value);
      if(!name || isNaN(point)) return;
      const snap = await get(ref(db, `scores/${name}`));
      if(snap.exists()) {
        await set(ref(db, `scores/${name}`), snap.val() + point);
        const histRef = push(ref(db, 'history'));
        await set(histRef, { date: new Date().toLocaleDateString('ko-KR'), name: name, mission: "ê´€ë¦¬ì ì¡°ì •", point: point });
        alert("ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!");
      } else { alert("ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); }
    };

    // --- 3. ìƒì„¸ ê¸°ë¡ ë° í˜ì´ì§€ë„¤ì´ì…˜ (í•µì‹¬!) ---
    onValue(ref(db, 'history'), (snap) => {
      const data = snap.val();
      allHistory = [];
      if(data) {
        for(let key in data) allHistory.push({ key, ...data[key] });
        allHistory.reverse(); // ìµœì‹ ìˆœ
      }
      filteredHistory = allHistory; // ì²˜ìŒì—” ì „ì²´ ë³´ì—¬ì£¼ê¸°
      renderHistory(1);
    });

    // ë‚ ì§œ ì¡°íšŒ ë²„íŠ¼
    document.getElementById('dateSearchBtn').onclick = () => {
      const selectedDate = document.getElementById('searchDate').value; // YYYY-MM-DD
      if(!selectedDate) { alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }
      
      // íŒŒì´ì–´ë² ì´ìŠ¤ ë‚ ì§œ í˜•ì‹ê³¼ ë§ì¶”ê¸° (ì˜ˆ: 2026. 2. 18.)
      const dateObj = new Date(selectedDate);
      const formattedDate = dateObj.toLocaleDateString('ko-KR'); 
      
      filteredHistory = allHistory.filter(h => h.date === formattedDate);
      currentPage = 1;
      renderHistory(1);
    };

    // ì „ì²´ë³´ê¸° ë²„íŠ¼
    document.getElementById('allSearchBtn').onclick = () => {
      filteredHistory = allHistory;
      currentPage = 1;
      renderHistory(1);
    };

    // ê¸°ë¡ ê·¸ë¦¬ê¸° í•¨ìˆ˜
    function renderHistory(page) {
      const area = document.getElementById('historyArea');
      area.innerHTML = "";
      
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = filteredHistory.slice(start, end);

      if(pageItems.length === 0) {
        area.innerHTML = "<p style='text-align:center; color:gray; padding-top:20px;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      }

      pageItems.forEach(h => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <div><strong>${h.name}</strong><br><small>${h.date}</small> - ${h.mission}</div>
          <div><b style="color:${h.point>=0?'blue':'red'}">${h.point>=0?'+'+h.point:h.point}</b> 
          <button class="btn-delete" onclick="cancelHistory('${h.key}')">ì·¨ì†Œ</button></div>
        `;
        area.appendChild(div);
      });

      renderPagination();
    }

    // í˜ì´ì§€ ë²ˆí˜¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜
    function renderPagination() {
      const area = document.getElementById('paginationArea');
      area.innerHTML = "";
      const totalPages = Math.ceil(filteredHistory.length / itemsPerPage);

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('span');
        btn.innerText = i;
        btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        btn.onclick = () => {
          currentPage = i;
          renderHistory(i);
          window.scrollTo(0, document.getElementById('historyArea').offsetTop - 50);
        };
        area.appendChild(btn);
      }
    }

    // ê¸°ë¡ ì·¨ì†Œ ë§ˆë²•
    window.cancelHistory = async (key) => {
      if(!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ê³  ì ìˆ˜ë¥¼ íšŒìˆ˜í• ê¹Œìš”?")) return;
      const snap = await get(ref(db, `history/${key}`));
      if(!snap.exists()) return;
      const h = snap.val();
      const scoreSnap = await get(ref(db, `scores/${h.name}`));
      if(scoreSnap.exists()) {
        await set(ref(db, `scores/${h.name}`), scoreSnap.val() - h.point);
      }
      // ë„ì¥ ê¸°ë¡ë„ ì‚­ì œ (ë‚ ì§œ ì  í¬í•¨ ì²˜ë¦¬)
      const dateKey = h.date.replace(/\./g, '').replace(/ /g, '-');
      await set(ref(db, `stamps/${h.name}/${dateKey}/${h.mission.replace(" (ìŠ¹ì¸)", "")}`), null);
      await set(ref(db, `history/${key}`), null);
    };
  </script>
</body>

</html>
