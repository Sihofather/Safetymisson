<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì ëª¨ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { text-align: center; background-color: #fff3e0; font-family: sans-serif; padding: 20px; }
    .box { background-color: white; padding: 25px; border-radius: 15px; display: inline-block; border: 2px solid #ff9800; max-width: 800px; width: 95%; text-align: left; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 20px; }
    h2 { text-align: center; color: #e65100; font-size: 34px; margin-bottom: 30px; }
    input, button, select { padding: 15px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; font-size: 20px; width: 100%; box-sizing: border-box; }
    button { background-color: #ff9800; color: white; border: none; cursor: pointer; font-weight: bold; margin-bottom: 15px; }
    button:hover { background-color: #f57c00; }
    h3 { color: #d84315; border-bottom: 2px solid #ffe0b2; padding-bottom: 5px; margin-top: 40px; font-size: 26px; }
    .history-item, .user-list-item, .req-item { font-size: 18px; padding: 15px; background-color: #fafafa; border-left: 5px solid #ff9800; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-radius: 0 5px 5px 0; }
    .btn-small { background-color: #4CAF50; padding: 10px 15px; font-size: 16px; width: auto; margin: 0 5px; }
    .btn-delete { background-color: #e53935; padding: 10px 15px; font-size: 16px; width: auto; margin: 0 0 0 10px; }
    #adminChatArea { height: 300px; overflow-y: auto; border: 1px solid #ccc; background-color: #f5f5f5; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
    .msg-worker { text-align: left; margin: 10px 0; }
    .msg-admin { text-align: right; margin: 10px 0; }
    .bubble { display: inline-block; padding: 10px; border-radius: 10px; max-width: 80%; font-size: 18px; word-break: break-all; }
    .bubble-worker { background-color: #fff; border: 1px solid #ccc; }
    .bubble-admin { background-color: #ffcc80; color: #000; }
    .time-text { font-size: 12px; color: gray; }
  </style>
</head>
<body>
  <div class="box">
    <h2>ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì ëª¨ë“œ</h2>

    <h3 style="margin-top: 0;">ğŸ› ï¸ ì¶”ê°€ ì•ˆì „ ë¯¸ì…˜ ì„¤ì •</h3>
    <div style="display:flex; gap:10px;">
      <input type="text" id="customMissionInput" placeholder="ì˜ˆ: ì‘ì—…ì¥ ì •ë¦¬ì •ëˆ">
      <button id="customMissionBtn" style="background-color:#8e24aa; width:150px;">ì ìš©</button>
      <button id="customMissionDelBtn" style="background-color:#757575; width:150px;">ì‚­ì œ</button>
    </div>

    <h3>ğŸ“¢ ì „ì²´ ê³µì§€ (í˜„ìˆ˜ë§‰ ë‹¬ê¸°)</h3>
    <input type="text" id="bannerText" placeholder="ì˜ˆ: ì˜¤ëŠ˜ 15ì‹œë¶€í„° ì •ì „ì…ë‹ˆë‹¤.">
    <div style="display:flex; gap:10px;">
      <button id="bannerBtn" style="background-color:#d32f2f;">í˜„ìˆ˜ë§‰ ê±¸ê¸°</button>
      <button id="bannerClearBtn" style="background-color:#757575;">í˜„ìˆ˜ë§‰ ë‚´ë¦¬ê¸°</button>
    </div>

    <h3>ğŸ”” ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ (ê±´ë‹¹ 30ì )</h3>
    <div id="requestArea" style="min-height: 50px; border: 1px solid #eee; padding: 10px;">ë¡œë”© ì¤‘...</div>

    <h3>âœ‰ï¸ 1:1 ê±´ì˜í•¨ (ìª½ì§€ ë³´ë‚´ê¸°)</h3>
    <select id="msgUserSelect"><option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option></select>
    <div id="adminChatArea">ì„ íƒí•˜ë©´ ëŒ€í™”ê°€ ë³´ì…ë‹ˆë‹¤.</div>
    <div style="display:flex; gap:10px;">
      <input type="text" id="adminMsgInput" placeholder="ë‹µê¸€ ë˜ëŠ” ìª½ì§€ ë‚´ìš© ì…ë ¥">
      <button id="adminMsgBtn" style="width: 100px; margin: 5px 0;">ì „ì†¡</button>
    </div>

    <h3>ğŸ“Š ìƒì„¸ í†µê³„ (ë¯¸ì…˜ í•­ëª©ë³„ ë¶„ì„)</h3>
    <select id="statUserSelect"><option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option></select>
    <div style="display:flex; gap:10px;">
      <select id="statTypeSelect" style="width: 50%;">
        <option value="daily">ì¼ë³„ ì¡°íšŒ</option>
        <option value="monthly">ì›”ë³„ ì¡°íšŒ (ëˆ„ì )</option>
      </select>
      <input type="date" id="statDateInput" style="width: 50%;">
      <input type="month" id="statMonthInput" style="display: none; width: 50%;">
    </div>
    <button id="drawChartBtn" style="background-color: #1976D2; width: 100%; margin-top:10px;">ê·¸ë˜í”„ ì¡°íšŒí•˜ê¸°</button>
    
    <div style="background: white; padding: 10px; border: 1px solid #ccc; border-radius: 10px; margin-top: 10px;">
      <canvas id="myChart"></canvas>
    </div>

    <h3>ğŸ“ ì „ì²´ ì§ì› ëª©ë¡</h3>
    <div id="userListArea" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px;"></div>

    <h3>â• ìƒˆ ì§ì› ë“±ë¡</h3>
    <div style="display:flex; gap:10px;">
      <input type="text" id="newName" placeholder="ìƒˆ ì§ì› ì´ë¦„ ì…ë ¥">
      <button id="regBtn" style="width: 150px; margin: 5px 0;">ë“±ë¡</button>
    </div>

    <div style="text-align: center; margin-top: 40px;">
      <button onclick="location.href='index.html'" style="background-color: #555; padding: 20px;">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </div>

  <script type="module">
    import { db, ref, set, get, push, onValue } from "./firebase-setup.js";

    // ë‚ ì§œ ì…ë ¥ì°½ ê¸°ë³¸ê°’ ì˜¤ëŠ˜/ì´ë²ˆë‹¬ë¡œ ì„¸íŒ…
    const today = new Date();
    document.getElementById('statDateInput').value = today.toISOString().split('T')[0];
    document.getElementById('statMonthInput').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;

    // ë¯¸ì…˜, í˜„ìˆ˜ë§‰, ìŠ¹ì¸ëŒ€ê¸°, ì§ì›ëª©ë¡, ìª½ì§€í•¨ ë¡œì§
    onValue(ref(db, 'settings/customMission'), (snap) => {
      if(snap.exists() && snap.val()) document.getElementById('customMissionInput').value = snap.val();
      else document.getElementById('customMissionInput').value = "";
    });
    document.getElementById('customMissionBtn').onclick = async () => {
      const text = document.getElementById('customMissionInput').value.trim();
      if(!text) return alert("ë¯¸ì…˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!");
      await set(ref(db, 'settings/customMission'), text); alert("ì¶”ê°€ ë¯¸ì…˜ ì ìš© ì™„ë£Œ!");
    };
    document.getElementById('customMissionDelBtn').onclick = async () => { await set(ref(db, 'settings/customMission'), null); alert("ì‚­ì œ ì™„ë£Œ!"); };

    onValue(ref(db, 'scores'), (snap) => {
      const msgSelect = document.getElementById('msgUserSelect');
      const statSelect = document.getElementById('statUserSelect');
      const listArea = document.getElementById('userListArea');
      msgSelect.innerHTML = '<option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
      statSelect.innerHTML = '<option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
      listArea.innerHTML = "";
      if(snap.exists()) {
        const data = snap.val();
        for(let name in data) {
          msgSelect.innerHTML += `<option value="${name}">${name} ë‹˜</option>`;
          statSelect.innerHTML += `<option value="${name}">${name} ë‹˜</option>`;
          listArea.innerHTML += `<div class='user-list-item'><span>${name}</span> <div><b>${data[name]}ì </b> <button class="btn-delete" onclick="deleteUser('${name}')">ì‚­ì œ</button></div></div>`;
        }
      }
    });

    document.getElementById('regBtn').onclick = async () => {
      const name = document.getElementById('newName').value.trim();
      if(!name) return; await set(ref(db, `scores/${name}`), 0);
      document.getElementById('newName').value = ""; alert(name + "ë‹˜ ë“±ë¡ ì™„ë£Œ!");
    };
    window.deleteUser = async (name) => {
      if(!confirm(`ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return; await set(ref(db, `scores/${name}`), null);
    };

    document.getElementById('bannerBtn').onclick = async () => {
      const text = document.getElementById('bannerText').value.trim();
      if(text) { await set(ref(db, 'settings/banner'), text); alert("ê²Œì‹œ ì™„ë£Œ!"); document.getElementById('bannerText').value=""; }
    };
    document.getElementById('bannerClearBtn').onclick = async () => { await set(ref(db, 'settings/banner'), null); };

    onValue(ref(db, 'requests'), (snap) => {
      const area = document.getElementById('requestArea'); area.innerHTML = ""; const data = snap.val();
      if(!data) { area.innerHTML = "<div style='color:gray;'>ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>"; return; }
      for(let key in data) {
        const req = data[key];
        area.innerHTML += `<div class='req-item'><div><b>${req.name}</b> <small>${req.date}</small><br>${req.mission}</div><div><button class="btn-small" onclick="approveReq('${key}', '${req.name}', '${req.mission}', '${req.date}')">ìŠ¹ì¸</button><button class="btn-delete" onclick="rejectReq('${key}')">ë°˜ë ¤</button></div></div>`;
      }
    });
    window.approveReq = async (key, name, mission, date) => {
      if(!confirm(`ìŠ¹ì¸í•˜ê³  30ì ì„ ë¶€ì—¬í• ê¹Œìš”?`)) return;
      const scoreSnap = await get(ref(db, `scores/${name}`));
      await set(ref(db, `scores/${name}`), (scoreSnap.exists() ? scoreSnap.val() : 0) + 30);
      await set(push(ref(db, 'history')), { date: date, name: name, mission: mission + "(ê´€ë¦¬ììŠ¹ì¸)", point: 30 });
      await set(ref(db, `requests/${key}`), null);
      await set(ref(db, `stamps/${name}/${date.replace(/\\./g, '').replace(/ /g, '-')}/${mission}`), true);
    };
    window.rejectReq = async (key) => { if(confirm("ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await set(ref(db, `requests/${key}`), null); };

    let currentChatUser = "";
    document.getElementById('msgUserSelect').onchange = (e) => {
      currentChatUser = e.target.value; const area = document.getElementById('adminChatArea');
      if(!currentChatUser) return area.innerHTML = "ì„ íƒí•´ì£¼ì„¸ìš”.";
      onValue(ref(db, `messages/${currentChatUser}`), (snap) => {
        area.innerHTML = ""; const data = snap.val();
        if(!data) return area.innerHTML = "<p>ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        for(let key in data) {
          const msg = data[key]; const isMe = msg.sender === 'admin';
          area.innerHTML += `<div class="${isMe ? 'msg-admin' : 'msg-worker'}"><span class="time-text">${isMe ? '' : currentChatUser}</span><div class="bubble ${isMe ? 'bubble-admin' : 'bubble-worker'}">${msg.text}</div><span class="time-text">${msg.time}</span></div>`;
        }
        area.scrollTop = area.scrollHeight;
      });
    };
    document.getElementById('adminMsgBtn').onclick = async () => {
      const text = document.getElementById('adminMsgInput').value.trim();
      if(!text || !currentChatUser) return;
      await set(push(ref(db, `messages/${currentChatUser}`)), { sender: 'admin', text: text, time: new Date().toLocaleString('ko-KR', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }) });
      document.getElementById('adminMsgInput').value = "";
    };

    // --- â­ í†µê³„ ê·¸ë˜í”„ (í•­ëª©ë³„ ê°€ë¡œì¶• ê³ ì • ë°°ì¹˜) â­ ---
    let myChartInstance = null; let allHistory = [];
    onValue(ref(db, 'history'), (snap) => {
      allHistory = []; if(snap.exists()) { const data = snap.val(); for(let key in data) allHistory.push(data[key]); }
    });

    document.getElementById('statTypeSelect').onchange = (e) => {
      if(e.target.value === 'daily') {
        document.getElementById('statDateInput').style.display = 'block';
        document.getElementById('statMonthInput').style.display = 'none';
      } else {
        document.getElementById('statDateInput').style.display = 'none';
        document.getElementById('statMonthInput').style.display = 'block';
      }
    };

    document.getElementById('drawChartBtn').onclick = () => {
      const name = document.getElementById('statUserSelect').value;
      const type = document.getElementById('statTypeSelect').value;
      if(!name) return alert("ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”!");

      let targetDateStr = "";
      if (type === 'daily') {
        const dateVal = document.getElementById('statDateInput').value;
        if(!dateVal) return alert("ì¡°íšŒí•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”!");
        targetDateStr = new Date(dateVal).toLocaleDateString('ko-KR'); 
      } else {
        const monthVal = document.getElementById('statMonthInput').value; 
        if(!monthVal) return alert("ì¡°íšŒí•  ë‹¬ì„ ì„ íƒí•˜ì„¸ìš”!");
        const [y, m] = monthVal.split('-');
        targetDateStr = `${y}. ${parseInt(m)}.`; 
      }

      const userHistory = allHistory.filter(h => {
         if(h.name !== name) return false;
         if(type === 'daily') return h.date === targetDateStr;
         return h.date.startsWith(targetDateStr); 
      });

      // â­ ëª¨ë“  ê¸°ë³¸ ë¯¸ì…˜ì„ 0ì ìœ¼ë¡œ ë¼ˆëŒ€(í‹€) ë§Œë“¤ê¸° â­
      const itemScores = {
        "TBM": 0, "ë³´í˜¸êµ¬ ì°©ìš©": 0, "ì•ˆì „ê°€ì´ë“œ í™œë™": 0, 
        "ì‘ì—… ì „ ìŠ¤íŠ¸ë ˆì¹­": 0, "ì‘ì—… ì „ 1ë¶„ ë©ˆì¶¤": 0, 
        "ì•„ì°¨ì‚¬ê³ ": 0, "ì œì•ˆì œì¶œ": 0
      };
      
      // ì»¤ìŠ¤í…€ ë¯¸ì…˜ì´ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ ì¶•ì— í¬í•¨
      const customMission = document.getElementById('customMissionInput').value.trim();
      if(customMission && itemScores[customMission] === undefined) {
        itemScores[customMission] = 0;
      }

      let totalScore = 0;

      // ì‹¤ì œ ê¸°ë¡ëœ ì ìˆ˜ ë®ì–´ì”Œìš°ê¸°
      userHistory.forEach(h => {
        let baseMission = h.mission.split('(')[0]; 
        if(itemScores[baseMission] === undefined) itemScores[baseMission] = 0; // í˜¹ì‹œ ê³¼ê±°ì— ë‹¤ë¥¸ ì´ë¦„ì˜ ë¯¸ì…˜ì´ ìˆì—ˆë‹¤ë©´ ì¶”ê°€
        itemScores[baseMission] += h.point;
        totalScore += h.point;
      });

      // ê°€ë¡œì¶• ë¼ë²¨ êµ¬ì„±: [ê° ë¯¸ì…˜ ì´ë¦„ë“¤..., "ì´ ì ìˆ˜"]
      const labels = Object.keys(itemScores);
      labels.push(type === 'daily' ? "ì¼ì¼ ì´ ì ìˆ˜" : "ì›”ê°„ ì´ ì ìˆ˜");
      
      const dataPoints = Object.values(itemScores);
      dataPoints.push(totalScore);

      const bgColors = labels.map((l, idx) => idx === labels.length - 1 ? 'rgba(230, 81, 0, 0.8)' : 'rgba(33, 150, 243, 0.6)');
      const borderColors = labels.map((l, idx) => idx === labels.length - 1 ? 'rgba(230, 81, 0, 1)' : 'rgba(33, 150, 243, 1)');

      const ctx = document.getElementById('myChart').getContext('2d');
      if (myChartInstance) myChartInstance.destroy(); 

      myChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'íšë“ ì ìˆ˜',
            data: dataPoints,
            backgroundColor: bgColors,
            borderColor: borderColors,
            borderWidth: 1
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });
    };
  </script>
</body>
</html>
