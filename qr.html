<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ë¯¸ì…˜</title>
  <style>
    body { text-align: center; background-color: #f0f4c3; font-family: sans-serif; padding: 20px; font-size: 20px; }
    .box { background-color: white; padding: 25px; border-radius: 20px; display: inline-block; border: 3px solid #afb42b; width: 95%; max-width: 500px; }
    h2 { font-size: 30px; }
    input { padding: 15px; font-size: 22px; width: 90%; margin-bottom: 25px; text-align: center; border: 2px solid #ccc; border-radius: 10px; }
    .mission-group { background-color: #f9fbe7; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #e6ee9c; }
    .group-title { font-size: 22px; color: #827717; font-weight: bold; margin-bottom: 15px; text-align: left; }
    .mission-btn { padding: 20px; margin: 8px 0; font-size: 20px; font-weight: bold; color: white; border: none; border-radius: 12px; cursor: pointer; width: 100%; display: block; line-height: 1.4; }
    .btn-self { background-color: #ff7043; } 
    .btn-admin { background-color: #26a69a; } 
    .qr-image { width: 220px; border: 3px solid #ccc; border-radius: 15px; margin: 20px 0; }
    #qrResult { margin-top: 20px; font-size: 22px; font-weight: bold; }
    a { font-size: 20px; text-decoration: none; color: #555; font-weight: bold; display: inline-block; margin-top: 20px; padding: 10px; }
  </style>
</head>
<body>
  <div class="box">
    <h2>ğŸ“ ì•ˆì „ ë¯¸ì…˜ ìˆ˜í–‰</h2>
    <input type="text" id="qrName" placeholder="ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”">
    
    <div class="mission-group">
      <div class="group-title">ğŸ™‹â€â™‚ï¸ ìŠ¤ìŠ¤ë¡œ í™•ì¸</div>
      <button class="mission-btn btn-self" id="btn-tbm">TBM ì™„ë£Œ (5ì )</button>
      <button class="mission-btn btn-self" id="btn-wear">ë³´í˜¸êµ¬ ì°©ìš© ì™„ë£Œ (5ì )</button>
      <button class="mission-btn btn-self" id="btn-guide">ì•ˆì „ê°€ì´ë“œ í™œë™ (10ì )</button>
      <button class="mission-btn btn-self" id="btn-patrol">ìœ í•´ìœ„í—˜ë°œêµ´ ìˆœì°° (10ì )</button>
    </div>

    <div class="mission-group">
      <div class="group-title">ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì ìŠ¹ì¸ ìš”ì²­</div>
      <button class="mission-btn btn-admin" id="btn-system">ì•ˆì „ê°€ì´ë“œ ìŠ¤ë§ˆíŠ¸ ì•ˆì „ë³´ê±´ì‹œìŠ¤í…œ<br>ë“±ë¡ ì™„ë£Œ (40ì )</button>
      <hr style="border: 0.5px dashed #ccc; margin: 20px 0;">
      <p style="font-size: 16px; color: #555; margin-bottom: 10px;">ğŸ‘‡ ì œì•ˆí™œë™ QRì½”ë“œë¥¼ ì°ì–´ ì œì¶œí•˜ì„¸ìš”!</p>
      <img src="ì œì•ˆQR.jpg" alt="ì œì•ˆ QR" class="qr-image">
      <button class="mission-btn btn-admin" id="btn-propose">ì œì•ˆ ì œì¶œ í›„ ìŠ¹ì¸ ìš”ì²­ (30ì )</button>
    </div>

    <div id="qrResult"></div>
    
    <a href="index.html">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <script type="module">
    import { db, ref, set, get, push } from "./firebase-setup.js";
    const resultDiv = document.getElementById("qrResult");
    async function handleMission(mission, point, type, msg) {
      const name = document.getElementById("qrName").value.trim();
      if (!name) { alert("ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš”!"); return; }
      const userRef = ref(db, `scores/${name}`);
      const userSnap = await get(userRef);
      if (!userSnap.exists()) { alert("ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤."); return; }
      const today = new Date().toLocaleDateString('ko-KR');
      const dateKey = today.replace(/\./g, '').replace(/ /g, '-');
      const todayRef = ref(db, `stamps/${name}/${dateKey}/${mission}`);
      const stampSnap = await get(todayRef);
      if (stampSnap.exists()) { resultDiv.innerHTML = "ì´ë¯¸ ì˜¤ëŠ˜ ì™„ë£Œí•œ ë¯¸ì…˜ì…ë‹ˆë‹¤! ğŸ˜…"; resultDiv.style.color = "red"; return; }
      if (type === 'self') {
        if (!confirm(msg)) return;
        await set(userRef, userSnap.val() + point);
        await set(todayRef, true);
        await set(push(ref(db, 'history')), { date: today, name: name, mission: mission, point: point });
        resultDiv.innerHTML = `ğŸ‰ '${mission}' ì™„ë£Œ! (+${point}ì )`;
        resultDiv.style.color = "blue";
      } else {
        await set(push(ref(db, 'requests')), { date: today, name: name, mission: mission, point: point });
        resultDiv.innerHTML = "âœ‰ï¸ ê´€ë¦¬ìì—ê²Œ ìŠ¹ì¸ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤!";
        resultDiv.style.color = "green";
      }
    }
    document.getElementById('btn-tbm').onclick = () => handleMission('TBM', 5, 'self', 'TBMì„ í•˜ì…¨ë‚˜ìš”?');
    document.getElementById('btn-wear').onclick = () => handleMission('ë³´í˜¸êµ¬', 5, 'self', 'ë³´í˜¸êµ¬ë¥¼ ì°©ìš©í•˜ì…¨ë‚˜ìš”?');
    document.getElementById('btn-guide').onclick = () => handleMission('ì•ˆì „ê°€ì´ë“œ', 10, 'self', 'ê°€ì´ë“œ í™œë™ì„ í•˜ì…¨ë‚˜ìš”?');
    document.getElementById('btn-patrol').onclick = () => handleMission('ìœ í•´ìœ„í—˜ë°œêµ´', 10, 'self', 'ìˆœì°°ì„ ì™„ë£Œí•˜ì…¨ë‚˜ìš”?');
    
    // â­ DBì— ì €ì¥ë˜ëŠ” ì´ë¦„ë„ ê¸¸ê²Œ ë³€ê²½ ì™„ë£Œ! â­
    document.getElementById('btn-system').onclick = () => handleMission('ì•ˆì „ê°€ì´ë“œ ìŠ¤ë§ˆíŠ¸ ì•ˆì „ë³´ê±´ì‹œìŠ¤í…œ ë“±ë¡', 40, 'admin');
    document.getElementById('btn-propose').onclick = () => handleMission('ì œì•ˆí™œë™', 30, 'admin');
  </script>
</body>
</html>