<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ë¯¸ì…˜</title>
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { text-align: center; background-color: #f0f4c3; font-family: sans-serif; padding: 20px; font-size: 20px; }
    .box { background-color: white; padding: 25px; border-radius: 20px; display: inline-block; border: 3px solid #afb42b; width: 95%; max-width: 500px; }
    h2 { font-size: 30px; }
    input { padding: 15px; font-size: 22px; width: 90%; margin-bottom: 25px; text-align: center; border: 2px solid #ccc; border-radius: 10px; }
    .mission-group { background-color: #f9fbe7; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #e6ee9c; }
    .group-title { font-size: 22px; color: #827717; font-weight: bold; margin-bottom: 15px; text-align: left; }
    .mission-btn { padding: 20px; margin: 8px 0; font-size: 20px; font-weight: bold; color: white; border: none; border-radius: 12px; cursor: pointer; width: 100%; display: block; line-height: 1.4; }
    .btn-self { background-color: #ff7043; } 
    .btn-admin { background-color: #26a69a; } 
    .qr-image { width: 220px; border: 3px solid #ccc; border-radius: 15px; margin: 20px 0; }
    #qrResult { margin-top: 20px; font-size: 22px; font-weight: bold; }
    a { font-size: 20px; text-decoration: none; color: #555; font-weight: bold; display: inline-block; margin-top: 20px; padding: 10px; background-color: #eee; border-radius: 10px; width: 80%; }
  </style>
</head>
<body>
  <div class="box">
    <h2>ğŸ“ ì•ˆì „ ë¯¸ì…˜ ìˆ˜í–‰</h2>
    <input type="text" id="qrName" placeholder="ë³¸ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
    
    <div class="mission-group">
      <div class="group-title">ğŸ™‹â€â™‚ï¸ ìŠ¤ìŠ¤ë¡œ í™•ì¸</div>
      <button class="mission-btn btn-self" id="btn-tbm">TBM ì™„ë£Œ (5ì )</button>
      <button class="mission-btn btn-self" id="btn-wear">ë³´í˜¸êµ¬ ì°©ìš© ì™„ë£Œ (5ì )</button>
      <button class="mission-btn btn-self" id="btn-guide">ì•ˆì „ê°€ì´ë“œ í™œë™ (10ì )</button>
      <button class="mission-btn btn-self" id="btn-patrol">ìœ í•´ìœ„í—˜ë°œêµ´ ìˆœì°° (10ì )</button>
    </div>

    <div class="mission-group">
      <div class="group-title">ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì ìŠ¹ì¸ ìš”ì²­</div>
      <button class="mission-btn btn-admin" id="btn-system">ì•„ì°¨ì‚¬ê³  ë“±ë¡ ì™„ë£Œ (40ì )</button>
      <hr style="border: 0.5px dashed #ccc; margin: 20px 0;">
      <p style="font-size: 16px; color: #555; margin-bottom: 10px;">ğŸ‘‡ ì œì•ˆí™œë™ QRì½”ë“œë¥¼ ì°ì–´ ì œì¶œí•˜ì„¸ìš”!</p>
      <img src="ì œì•ˆQR.jpg" alt="ì œì•ˆ QR" class="qr-image">
      <button class="mission-btn btn-admin" id="btn-propose">ì œì•ˆ ì œì¶œ í›„ ìŠ¹ì¸ ìš”ì²­ (30ì )</button>
    </div>

    <div id="qrResult"></div>
    <a href="index.html">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <script type="module">
    import { db, ref, set, get, push } from "./firebase-setup.js";
    const resultDiv = document.getElementById("qrResult");

    async function handleMission(mission, point, type, msg) {
      const name = document.getElementById("qrName").value.trim();
      
      // 1. ì´ë¦„ ì•ˆ ì ì—ˆì„ ë•Œì˜ ì˜ˆìœ ê²½ê³ ì°½
      if (!name) { 
        Swal.fire({ icon: 'warning', title: 'ì•Œë¦¼', text: 'ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!' });
        return; 
      }
      
      const userRef = ref(db, `scores/${name}`);
      const userSnap = await get(userRef);
      
      // 2. ë“±ë¡ ì•ˆ ëœ ì‚¬ìš©ìì¼ ë•Œì˜ ì˜ˆìœ ê²½ê³ ì°½
      if (!userSnap.exists()) { 
        Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜', text: 'ì‹œìŠ¤í…œì— ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë¦„ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.' });
        return; 
      }
      
      const today = new Date().toLocaleDateString('ko-KR');
      const dateKey = today.replace(/\./g, '').replace(/ /g, '-');
      const todayRef = ref(db, `stamps/${name}/${dateKey}/${mission}`);
      const stampSnap = await get(todayRef);
      
      // 3. ì¤‘ë³µ ì°¸ì—¬ì¼ ë•Œì˜ ì˜ˆìœ ê²½ê³ ì°½
      if (stampSnap.exists()) { 
        Swal.fire({ icon: 'info', title: 'ì•—!', text: 'ì´ë¯¸ ì˜¤ëŠ˜ ì™„ë£Œí•œ ë¯¸ì…˜ì…ë‹ˆë‹¤! ğŸ˜…' });
        return; 
      }
      
      if (type === 'self') {
        // â­ 4. ì´ŒìŠ¤ëŸ¬ìš´ confirm ì°½ ëŒ€ì‹  ì˜ˆìœ ì§ˆë¬¸ ì°½ ë„ìš°ê¸° â­
        const result = await Swal.fire({
          title: 'ë¯¸ì…˜ í™•ì¸',
          text: msg,
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#ff7043',
          cancelButtonColor: '#999',
          confirmButtonText: 'ë„¤, ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!',
          cancelButtonText: 'ì•„ì§ì´ìš”'
        });

        // 'ì•„ì§ì´ìš”'ë¥¼ ëˆ„ë¥´ë©´ ì—¬ê¸°ì„œ ë
        if (!result.isConfirmed) return;

        // 'ë„¤'ë¥¼ ëˆ„ë¥´ë©´ ì ìˆ˜ ì¶”ê°€ ì§„í–‰
        await set(userRef, userSnap.val() + point);
        await set(todayRef, true);
        await set(push(ref(db, 'history')), { date: today, name: name, mission: mission, point: point });
        
        Swal.fire({ icon: 'success', title: 'ì„±ê³µ!', text: `ğŸ‰ '${mission}' ì™„ë£Œ! (+${point}ì )` });
        resultDiv.innerHTML = `ğŸ‰ '${mission}' ì™„ë£Œ! (+${point}ì )`;
        resultDiv.style.color = "blue";
        
      } else {
        // â­ 5. ê´€ë¦¬ì ìŠ¹ì¸ ìš”ì²­ ì°½ â­
        const result = await Swal.fire({
          title: 'ìŠ¹ì¸ ìš”ì²­',
          text: `'${mission}' ë¯¸ì…˜ ìŠ¹ì¸ì„ ê´€ë¦¬ìì—ê²Œ ìš”ì²­í• ê¹Œìš”?`,
          icon: 'info',
          showCancelButton: true,
          confirmButtonColor: '#26a69a',
          cancelButtonColor: '#999',
          confirmButtonText: 'ìš”ì²­í•˜ê¸°',
          cancelButtonText: 'ì·¨ì†Œ'
        });

        if (!result.isConfirmed) return;

        await set(push(ref(db, 'requests')), { date: today, name: name, mission: mission, point: point });
        
        Swal.fire({ icon: 'success', title: 'ìš”ì²­ ì™„ë£Œ!', text: 'âœ‰ï¸ ê´€ë¦¬ìì—ê²Œ ìŠ¹ì¸ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤!' });
        resultDiv.innerHTML = "âœ‰ï¸ ê´€ë¦¬ìì—ê²Œ ìŠ¹ì¸ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤!";
        resultDiv.style.color = "green";
      }
    }

    document.getElementById('btn-tbm').onclick = () => handleMission('TBM', 5, 'self', 'ì‘ì—… ì „ TBMì„ í•˜ì…¨ë‚˜ìš”?');
    document.getElementById('btn-wear').onclick = () => handleMission('ë³´í˜¸êµ¬', 5, 'self', 'ì•ˆì „ ë³´í˜¸êµ¬ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì°©ìš©í•˜ì…¨ë‚˜ìš”?');
    document.getElementById('btn-guide').onclick = () => handleMission('ì•ˆì „ê°€ì´ë“œ', 10, 'self', 'ì•ˆì „ê°€ì´ë“œ í™œë™ì„ ìˆ˜í–‰í•˜ì…¨ë‚˜ìš”?');
    document.getElementById('btn-patrol').onclick = () => handleMission('ìœ í•´ìœ„í—˜ë°œêµ´', 10, 'self', 'ìœ í•´ìœ„í—˜ë°œêµ´ ìˆœì°°ì„ ì™„ë£Œí•˜ì…¨ë‚˜ìš”?');
    
    document.getElementById('btn-system').onclick = () => handleMission('ì•„ì°¨ì‚¬ê³  ë“±ë¡', 40, 'admin');
    document.getElementById('btn-propose').onclick = () => handleMission('ì œì•ˆí™œë™', 30, 'admin');
  </script>
</body>
</html>
