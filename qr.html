<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ë¯¸ì…˜</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { text-align: center; background-color: #f0f4c3; font-family: sans-serif; padding: 20px; font-size: 20px; }
    .box { background-color: white; padding: 25px; border-radius: 20px; display: inline-block; border: 3px solid #afb42b; width: 95%; max-width: 500px; }
    h2 { font-size: 30px; }
    input[type=text] { padding: 15px; font-size: 22px; width: 90%; margin-bottom: 25px; text-align: center; border: 2px solid #ccc; border-radius: 10px; }
    .mission-group { background-color: #f9fbe7; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #e6ee9c; }
    .group-title { font-size: 22px; color: #827717; font-weight: bold; margin-bottom: 15px; text-align: left; }
    .mission-btn { padding: 20px; margin: 8px 0; font-size: 22px; font-weight: bold; color: white; border: none; border-radius: 12px; cursor: pointer; width: 100%; display: block; line-height: 1.4; }
    .btn-self { background-color: #ff7043; } 
    .btn-custom { background-color: #8e24aa; } /* ì»¤ìŠ¤í…€ ë¯¸ì…˜ ë³´ë¼ìƒ‰ ë²„íŠ¼ */
    .btn-admin { background-color: #26a69a; } 
    .qr-image { width: 220px; border: 3px solid #ccc; border-radius: 15px; margin: 20px 0; }
    #qrResult { margin-top: 20px; font-size: 20px; font-weight: bold; }
    a.home-link { font-size: 20px; text-decoration: none; color: #555; font-weight: bold; display: inline-block; margin-top: 20px; padding: 15px; background-color: #eee; border-radius: 10px; width: 80%; }

    .swal2-radio { display: flex !important; flex-direction: column; gap: 15px; margin-top: 20px !important; padding: 0 10px; }
    .swal2-radio label { display: flex !important; align-items: center; justify-content: flex-start; font-size: 24px !important; padding: 15px 20px !important; background-color: #fffde7; border: 2px solid #fbc02d; border-radius: 15px; cursor: pointer; width: 100%; box-sizing: border-box; }
    .swal2-radio input[type="radio"] { transform: scale(2.0); margin-right: 20px !important; margin-top: 0 !important; }
    .swal2-radio label:hover { background-color: #fff9c4; }
  </style>
</head>
<body>
  <div class="box">
    <h2>ğŸ“ ì•ˆì „ ë¯¸ì…˜ ìˆ˜í–‰</h2>
    <input type="text" id="qrName" placeholder="ë³¸ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
    
    <div class="mission-group">
      <div class="group-title">ğŸ™‹â€â™‚ï¸ ìŠ¤ìŠ¤ë¡œ í™•ì¸</div>
      <button class="mission-btn btn-self" id="btn-tbm">TBM</button>
      <button class="mission-btn btn-self" id="btn-wear">ë³´í˜¸êµ¬ ì°©ìš©</button>
      <button class="mission-btn btn-self" id="btn-guide">ì•ˆì „ê°€ì´ë“œ í™œë™</button>
      <button class="mission-btn btn-self" id="btn-stretch">ì‘ì—… ì „ ìŠ¤íŠ¸ë ˆì¹­</button>
      <button class="mission-btn btn-self" id="btn-stop">ì‘ì—… ì „ 1ë¶„ ë©ˆì¶¤ (ìœ„í—˜ìš”ì¸ ì‚´í”¼ê¸°)</button>
      
      <div id="customMissionArea"></div>
    </div>

    <div class="mission-group">
      <div class="group-title">ğŸ‘¨â€ğŸ’¼ ë‚˜ì˜ ì œì•ˆ (ê´€ë¦¬ì ìŠ¹ì¸)</div>
      <p style="font-size: 16px; color: #555; margin-bottom: 10px;">ğŸ‘‡ QRì½”ë“œë¥¼ ì°ì–´ ë‚´ìš©ì„ ì œì¶œí•œ ë’¤,<br>ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ê´€ë¦¬ìì—ê²Œ ìŠ¹ì¸ì„ ìš”ì²­í•˜ì„¸ìš”!</p>
      <img src="ì œì•ˆQR.jpg" alt="ì œì•ˆ QR" class="qr-image">
      <button class="mission-btn btn-admin" id="btn-system">ì•„ì°¨ì‚¬ê³  ìŠ¹ì¸ ìš”ì²­</button>
      <button class="mission-btn btn-admin" id="btn-propose">ì œì•ˆì œì¶œ ìŠ¹ì¸ ìš”ì²­</button>
    </div>

    <div id="qrResult"></div>
    <a href="index.html" class="home-link">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <script type="module">
    import { db, ref, set, get, push, onValue } from "./firebase-setup.js";
    const resultDiv = document.getElementById("qrResult");

    // ê´€ë¦¬ìê°€ ì¶”ê°€í•œ ì»¤ìŠ¤í…€ ë¯¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸° ë§ˆë²•
    onValue(ref(db, 'settings/customMission'), (snap) => {
      const area = document.getElementById("customMissionArea");
      if(snap.exists() && snap.val() !== "") {
        const customName = snap.val();
        area.innerHTML = `<button class="mission-btn btn-custom" id="btn-custom">â• ${customName}</button>`;
        document.getElementById('btn-custom').onclick = () => handleSelfCheck(customName);
      } else {
        area.innerHTML = "";
      }
    });

    async function checkUserAndStamp(mission) {
      const name = document.getElementById("qrName").value.trim();
      if (!name) { Swal.fire({ icon: 'warning', title: 'ì•Œë¦¼', text: 'ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!' }); return null; }
      const userRef = ref(db, `scores/${name}`);
      const userSnap = await get(userRef);
      if (!userSnap.exists()) { Swal.fire({ icon: 'error', title: 'ì˜¤ë¥˜', text: 'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë¦„ì…ë‹ˆë‹¤.' }); return null; }
      
      const today = new Date().toLocaleDateString('ko-KR');
      const dateKey = today.replace(/\./g, '').replace(/ /g, '-');
      const stampRef = ref(db, `stamps/${name}/${dateKey}/${mission}`);
      const stampSnap = await get(stampRef);
      if (stampSnap.exists()) { Swal.fire({ icon: 'info', title: 'ì•—!', text: 'ì´ë¯¸ ì˜¤ëŠ˜ ì™„ë£Œí•œ ë¯¸ì…˜ì…ë‹ˆë‹¤! ğŸ˜…' }); return null; }
      
      return { name, userRef, currentScore: userSnap.val(), stampRef, today };
    }

    async function handleSelfCheck(mission) {
      const data = await checkUserAndStamp(mission);
      if (!data) return;

      const { value: selectedLevel } = await Swal.fire({
        title: `'${mission}' í‰ê°€`,
        html: '<span style="font-size: 18px;">ìŠ¤ìŠ¤ë¡œì˜ í™œë™ì„ ì†”ì§í•˜ê²Œ í‰ê°€í•´ì£¼ì„¸ìš”!</span>',
        icon: 'question',
        input: 'radio',
        inputOptions: new Map([['5', 'ì™„ì „ ì˜í–ˆìŒ'], ['3', 'ì˜í–ˆìŒ'], ['1', 'ëª»í–ˆìŒ']]),
        inputValidator: (value) => { if (!value) return 'í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'; },
        showCancelButton: true, confirmButtonColor: '#ff7043', cancelButtonColor: '#999', confirmButtonText: 'ê¸°ë¡í•˜ê¸°', cancelButtonText: 'ì·¨ì†Œ', width: '90%'
      });

      if (selectedLevel) {
        const point = parseInt(selectedLevel);
        const levelText = point === 5 ? "(ì™„ì „ì˜í•¨)" : point === 3 ? "(ì˜í•¨)" : "(ëª»í•¨)";
        await set(data.userRef, data.currentScore + point);
        await set(data.stampRef, true);
        await set(push(ref(db, 'history')), { date: data.today, name: data.name, mission: mission + levelText, point: point });
        Swal.fire({ icon: 'success', title: 'ì„±ê³µ!', text: `'${mission}' ê¸°ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.` });
        resultDiv.innerHTML = `âœ… '${mission}' ê¸°ë¡ ì™„ë£Œ!`; resultDiv.style.color = "blue";
      }
    }

    async function handleAdminRequest(mission) {
      const data = await checkUserAndStamp(mission);
      if (!data) return;
      const result = await Swal.fire({ title: 'ìŠ¹ì¸ ìš”ì²­', text: `'${mission}' ìŠ¹ì¸ì„ ìš”ì²­í• ê¹Œìš”?`, icon: 'info', showCancelButton: true, confirmButtonColor: '#26a69a', confirmButtonText: 'ìš”ì²­í•˜ê¸°', cancelButtonText: 'ì·¨ì†Œ' });
      if (result.isConfirmed) {
        await set(push(ref(db, 'requests')), { date: data.today, name: data.name, mission: mission, stampKey: data.stampRef.key });
        Swal.fire({ icon: 'success', title: 'ìš”ì²­ ì™„ë£Œ!', text: 'âœ‰ï¸ ê´€ë¦¬ìì—ê²Œ ìŠ¹ì¸ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤!' });
        resultDiv.innerHTML = "âœ‰ï¸ ê´€ë¦¬ìì—ê²Œ ìŠ¹ì¸ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤!"; resultDiv.style.color = "green";
      }
    }

    document.getElementById('btn-tbm').onclick = () => handleSelfCheck('TBM');
    document.getElementById('btn-wear').onclick = () => handleSelfCheck('ë³´í˜¸êµ¬ ì°©ìš©');
    document.getElementById('btn-guide').onclick = () => handleSelfCheck('ì•ˆì „ê°€ì´ë“œ í™œë™');
    document.getElementById('btn-stretch').onclick = () => handleSelfCheck('ì‘ì—… ì „ ìŠ¤íŠ¸ë ˆì¹­');
    document.getElementById('btn-stop').onclick = () => handleSelfCheck('ì‘ì—… ì „ 1ë¶„ ë©ˆì¶¤');
    
    document.getElementById('btn-system').onclick = () => handleAdminRequest('ì•„ì°¨ì‚¬ê³ ');
    document.getElementById('btn-propose').onclick = () => handleAdminRequest('ì œì•ˆì œì¶œ');
  </script>
</body>
</html>
