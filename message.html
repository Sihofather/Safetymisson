<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1:1 ê±´ì˜í•¨</title>
  <style>
    body { text-align: center; background-color: #f3e5f5; font-family: sans-serif; padding: 20px; font-size: 18px; }
    .box { background-color: white; padding: 20px; border-radius: 15px; display: inline-block; border: 3px solid #9c27b0; width: 95%; max-width: 500px; }
    h2 { color: #6a1b9a; margin-top: 0; }
    input, button { padding: 12px; font-size: 18px; margin: 5px; border-radius: 8px; border: 1px solid #ccc; width: 90%; }
    button { background-color: #ab47bc; color: white; font-weight: bold; border: none; cursor: pointer; }
    #chatArea { height: 350px; overflow-y: auto; background-color: #fafafa; border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin: 15px 0; display: none; text-align: left; }
    
    /* ì±„íŒ… ë§í’ì„  ìŠ¤íƒ€ì¼ */
    .msg-box { margin-bottom: 10px; display: flex; flex-direction: column; }
    .msg-worker { align-items: flex-end; } /* ë‚´ ê¸€ì€ ì˜¤ë¥¸ìª½ */
    .msg-admin { align-items: flex-start; } /* ê´€ë¦¬ì ê¸€ì€ ì™¼ìª½ */
    
    .bubble { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 16px; line-height: 1.4; word-break: break-all; }
    .bubble-worker { background-color: #ce93d8; color: #000; border-bottom-right-radius: 2px; }
    .bubble-admin { background-color: #e0e0e0; color: #000; border-bottom-left-radius: 2px; border: 1px solid #ccc; }
    .time-text { font-size: 11px; color: gray; margin: 2px 5px; }

    .home-link { display: inline-block; padding: 15px; background-color: #eee; text-decoration: none; color: #333; font-weight: bold; border-radius: 10px; margin-top: 10px; width: 85%; }
  </style>
</head>
<body>
  <div class="box">
    <h2>âœ‰ï¸ 1:1 ë¹„ë°€ ê±´ì˜í•¨</h2>
    <p style="font-size: 14px; color: gray;">ê´€ë¦¬ìë§Œ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìµëª… ë³´ì¥!</p>
    
    <div id="loginArea">
      <input type="text" id="myName" placeholder="ë³¸ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
      <button id="loginBtn">ë‚´ ê±´ì˜í•¨ ì—´ê¸°</button>
    </div>

    <div id="chatArea"></div>

    <div id="inputArea" style="display: none;">
      <input type="text" id="myMsg" placeholder="ì—¬ê¸°ì— ê±´ì˜ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”">
      <button id="sendBtn">ê´€ë¦¬ìì—ê²Œ ì „ì†¡</button>
    </div>

    <a href="index.html" class="home-link">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <script type="module">
    import { db, ref, set, get, push, onValue } from "./firebase-setup.js";
    let currentUser = "";

    document.getElementById('loginBtn').onclick = async () => {
      const name = document.getElementById('myName').value.trim();
      if(!name) { alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!"); return; }
      const snap = await get(ref(db, `scores/${name}`));
      if(!snap.exists()) { alert("ì‹œìŠ¤í…œì— ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë¦„ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."); return; }
      
      currentUser = name;
      document.getElementById('loginArea').style.display = 'none';
      document.getElementById('chatArea').style.display = 'block';
      document.getElementById('inputArea').style.display = 'block';
      loadMessages();
    };

    function loadMessages() {
      onValue(ref(db, `messages/${currentUser}`), (snap) => {
        const data = snap.val();
        const area = document.getElementById('chatArea');
        area.innerHTML = "";
        if(!data) { area.innerHTML = "<p style='text-align:center; color:gray; margin-top:50px;'>ì²« ê±´ì˜ì‚¬í•­ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>"; return; }
        
        for(let key in data) {
          const msg = data[key];
          const isMe = msg.sender === 'worker';
          const alignClass = isMe ? 'msg-worker' : 'msg-admin';
          const bubbleClass = isMe ? 'bubble-worker' : 'bubble-admin';
          const senderName = isMe ? 'ë‚˜' : 'ğŸ‘¨â€ğŸ’¼ê´€ë¦¬ì';

          area.innerHTML += `
            <div class='msg-box ${alignClass}'>
              <span class='time-text'>${senderName}</span>
              <div class='bubble ${bubbleClass}'>${msg.text}</div>
              <span class='time-text'>${msg.time}</span>
            </div>
          `;
        }
        area.scrollTop = area.scrollHeight; // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
      });
    }

    document.getElementById('sendBtn').onclick = async () => {
      const text = document.getElementById('myMsg').value.trim();
      if(!text) return;
      const time = new Date().toLocaleString('ko-KR', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
      await set(push(ref(db, `messages/${currentUser}`)), { sender: 'worker', text: text, time: time });
      document.getElementById('myMsg').value = "";
    };
  </script>
</body>
</html>
