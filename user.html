<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚´ ìƒíƒœ í™•ì¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { text-align: center; background-color: #e0f7fa; font-family: sans-serif; padding: 20px; font-size: 20px; }
    .box { background-color: white; padding: 30px; border-radius: 20px; display: inline-block; border: 3px solid #00acc1; width: 95%; max-width: 450px; }
    h2 { font-size: 32px; color: #00838f; margin-bottom: 20px; }
    input { padding: 15px; font-size: 20px; border: 2px solid #ccc; border-radius: 10px; box-sizing: border-box; }
    #checkName { width: 100%; margin-bottom: 15px; text-align: center; font-size: 22px; }
    button { padding: 15px; font-size: 22px; font-weight: bold; background-color: #00acc1; color: white; border: none; border-radius: 10px; cursor: pointer; width: 100%; margin-top: 10px; }
    #scoreResult { margin-top: 20px; font-size: 22px; font-weight: bold; color: #d84315; line-height: 1.5; }
    .chart-container { display: none; margin-top: 20px; padding: 10px; border: 2px dashed #4dd0e1; border-radius: 15px; background-color: #f8ffff; }
    .home-link { font-size: 20px; text-decoration: none; color: #555; font-weight: bold; padding: 15px; display: inline-block; margin-top: 30px; background-color: #eee; border-radius: 10px; width: 85%; }
  </style>
</head>
<body>
  <div class="box">
    <h2>ğŸ‘·â€â™‚ï¸ ë‚´ í™œë™ ìƒíƒœ í™•ì¸</h2>
    <input type="text" id="checkName" placeholder="ë³¸ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
    
    <div style="margin-bottom: 15px; text-align: left;">
      <label style="font-size: 16px; color: #00838f; font-weight: bold;">ğŸ“… ì¡°íšŒí•  ë‹¬ ì„ íƒ:</label>
      <input type="month" id="statMonthInput" style="width: 100%; margin-top: 5px;">
    </div>

    <button id="checkBtn">ë‚˜ì˜ í™œë™ ë¶„ì„í•˜ê¸°</button>
    
    <div id="scoreResult"></div>
    
    <div class="chart-container" id="chartBox">
      <p style="font-size: 16px; color: #00838f; margin-bottom: 5px; font-weight: bold;">ğŸ“ˆ ì›”ê°„ í•­ëª©ë³„ í™œë™ëŸ‰ ë¹„êµ</p>
      <canvas id="userChart"></canvas>
      <p style="font-size: 13px; color: gray; margin-top: 5px;">â€» ë§‰ëŒ€ì˜ ë†’ì´ë¡œ ë‚˜ì˜ ë…¸ë ¥(í™œë™ëŸ‰)ì„ í™•ì¸í•˜ì„¸ìš”!</p>
    </div>

    <a href="index.html" class="home-link">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <script type="module">
    import { db, ref, get, onValue } from "./firebase-setup.js";
    
    // ì´ë²ˆ ë‹¬ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¸íŒ…
    const today = new Date();
    document.getElementById('statMonthInput').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;

    let allHistory = [];
    onValue(ref(db, 'history'), (snap) => {
      allHistory = [];
      if(snap.exists()) {
        const data = snap.val();
        for(let key in data) allHistory.push(data[key]);
      }
    });

    let customMissionName = "";
    onValue(ref(db, 'settings/customMission'), (snap) => {
      if(snap.exists() && snap.val()) customMissionName = snap.val();
    });

    let myChart = null;

    document.getElementById('checkBtn').onclick = async () => {
      const name = document.getElementById('checkName').value.trim();
      const monthVal = document.getElementById('statMonthInput').value;
      
      if (!name) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
      if (!monthVal) { alert("ì¡°íšŒí•  ë‹¬ì„ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }

      const [y, m] = monthVal.split('-');
      const targetDateStr = `${y}. ${parseInt(m)}.`;

      // ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      const userSnap = await get(ref(db, `scores/${name}`));
      if (!userSnap.exists()) {
        document.getElementById('scoreResult').innerHTML = "ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë¦„ì…ë‹ˆë‹¤.";
        document.getElementById('chartBox').style.display = "none";
        return;
      }

      // 1. í•´ë‹¹ ì›” ë°ì´í„° í•„í„°ë§
      const userHistory = allHistory.filter(h => h.name === name && h.date.startsWith(targetDateStr));

      // â­ ëª¨ë“  ê¸°ë³¸ ë¯¸ì…˜ì„ 0ì ìœ¼ë¡œ ë¼ˆëŒ€(í‹€) ë§Œë“¤ê¸° â­
      const itemScores = {
        "TBM": 0, "ë³´í˜¸êµ¬ ì°©ìš©": 0, "ì•ˆì „ê°€ì´ë“œ í™œë™": 0, 
        "ì‘ì—… ì „ ìŠ¤íŠ¸ë ˆì¹­": 0, "ì‘ì—… ì „ 1ë¶„ ë©ˆì¶¤": 0, 
        "ì•„ì°¨ì‚¬ê³ ": 0, "ì œì•ˆì œì¶œ": 0
      };
      
      // ì»¤ìŠ¤í…€ ë¯¸ì…˜ì´ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ ì¶•ì— í¬í•¨
      if(customMissionName && itemScores[customMissionName] === undefined) {
        itemScores[customMissionName] = 0;
      }

      let totalScore = 0;
      let uniqueDays = new Set();

      userHistory.forEach(h => {
        let baseMission = h.mission.split('(')[0]; 
        if(itemScores[baseMission] === undefined) itemScores[baseMission] = 0;
        itemScores[baseMission] += h.point;
        totalScore += h.point;
        uniqueDays.add(h.date);
      });

      // 2. ì¹­ì°¬ ë©˜íŠ¸ í‘œì‹œ
      if(totalScore === 0) {
        document.getElementById('scoreResult').innerHTML = `
          <span style="color:#00838f;">ì´ë‹¬ì˜ í™œë™ í‰ê°€:</span><br><br>
          <span style="font-size:24px; color:#d32f2f;">"ì•„ì§ ì´ë²ˆ ë‹¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. íŒŒì´íŒ…!"</span>
        `;
      } else {
        let daysCount = uniqueDays.size > 0 ? uniqueDays.size : 1;
        let msg = "";
        if (totalScore >= 30 * daysCount) msg = "ëŒ€ë‹¨í•´ìš”~! ê³„ì† ìœ ì§€í•´ì£¼ì„¸ìš”! ğŸŒŸ";
        else if (totalScore >= 20 * daysCount) msg = "ì˜í•˜ê³  ìˆì–´ìš”! ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì£¼ì„¸ìš”! ğŸ‘";
        else msg = "ë” ì¢‹ì•„ì§ˆ ìˆ˜ ìˆì–´ìš”! í•¨ê»˜ ë³´ì™„í•´ë´…ì‹œë‹¤! ğŸ’ª";

        document.getElementById('scoreResult').innerHTML = `
          <span style="color:#00838f;">ì´ë‹¬ì˜ í™œë™ í‰ê°€:</span><br><br>
          <span style="font-size:26px;">"${msg}"</span>
        `;
      }

      // 3. ìˆ«ì ì—†ëŠ” í™œë™ëŸ‰ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
      const labels = Object.keys(itemScores);
      labels.push("ì´ í™œë™ëŸ‰");
      
      const dataPoints = Object.values(itemScores);
      dataPoints.push(totalScore);

      const bgColors = labels.map((l, idx) => idx === labels.length - 1 ? 'rgba(0, 150, 136, 0.8)' : 'rgba(0, 188, 212, 0.5)');
      const borderColors = labels.map((l, idx) => idx === labels.length - 1 ? 'rgba(0, 150, 136, 1)' : 'rgba(0, 188, 212, 1)');

      document.getElementById('chartBox').style.display = "block";
      const ctx = document.getElementById('userChart').getContext('2d');
      if(myChart) myChart.destroy();

      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'ì‹¤ì²œë„',
            data: dataPoints,
            backgroundColor: bgColors,
            borderColor: borderColors,
            borderWidth: 2,
            borderRadius: 5
          }]
        },
        options: {
          responsive: true,
          scales: {
            // Yì¶• ìˆ«ì ì™„ì „ ìˆ¨ê¹€
            y: { display: false, beginAtZero: true },
            x: { grid: { display: false } }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                // ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ì ìˆ˜ ëŒ€ì‹  ì¹­ì°¬ ë©˜íŠ¸ í‘œì‹œ
                label: function() { return "í›Œë¥­í•œ ì‹¤ì²œì…ë‹ˆë‹¤! ğŸ‘"; }
              }
            }
          }
        }
      });
    };
  </script>
</body>
</html>
